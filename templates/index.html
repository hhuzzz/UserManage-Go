<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        .table {
            margin-bottom: 0;
        }
        .table thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd1 0%, #6a4190 100%);
        }
        .badge-active {
            background-color: #28a745;
        }
        .badge-inactive {
            background-color: #dc3545;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-people-fill me-2"></i>用户管理系统
            </a>
            <div id="navAuthButtons">
                <a href="/login" class="btn btn-outline-light btn-sm me-2">
                    <i class="bi bi-person-plus me-1"></i>注册
                </a>
                <button class="btn btn-light btn-sm" onclick="showLoginModal()">
                    <i class="bi bi-box-arrow-in-right me-1"></i>登录
                </button>
            </div>
            <div id="navUserInfo" style="display: none;">
                <span class="navbar-text me-3" id="welcomeText"></span>
                <button class="btn btn-outline-light btn-sm" onclick="showChangePasswordModal()">
                    <i class="bi bi-key me-1"></i>修改密码
                </button>
                <button class="btn btn-light btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right me-1"></i>退出
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <div class="container mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-list-ul me-2"></i>用户列表</span>
                <button class="btn btn-light btn-sm" onclick="showCreateModal()">
                    <i class="bi bi-plus-lg me-1"></i>新增用户
                </button>
            </div>
            <div class="card-body">
                <!-- 未登录提示 -->
                <div id="loginRequired" style="display: none;">
                    <div class="text-center py-5">
                        <i class="bi bi-lock-fill fs-1 text-muted d-block mb-3"></i>
                        <h4 class="text-muted">请先登录</h4>
                        <p class="text-muted">登录后即可查看和管理用户数据</p>
                        <div class="mt-3">
                            <a href="/login" class="btn btn-outline-primary me-2">
                                <i class="bi bi-person-plus me-1"></i>注册账号
                            </a>
                            <button class="btn btn-primary" onclick="showLoginModal()">
                                <i class="bi bi-box-arrow-in-right me-2"></i>立即登录
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 登录后的内容 -->
                <div id="userContent">
                    {{if .error}}
                    <div class="alert alert-danger" role="alert">
                        {{.error}}
                    </div>
                    {{end}}

                    <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>姓名</th>
                                <th>邮箱</th>
                                <th>电话</th>
                                <th>年龄</th>
                                <th>状态</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .users}}
                            <tr>
                                <td>{{.ID}}</td>
                                <td>{{.Name}}</td>
                                <td>{{.Email}}</td>
                                <td>{{.Phone}}</td>
                                <td>{{.Age}}</td>
                                <td>
                                    {{if eq .Status 1}}
                                    <span class="badge badge-active">活跃</span>
                                    {{else}}
                                    <span class="badge badge-inactive">未激活</span>
                                    {{end}}
                                </td>
                                <td>{{.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary action-btn" onclick="showEditModal({{.ID}})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger action-btn" onclick="deleteUser({{.ID}})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {{else}}
                            <tr>
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    暂无数据
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">用户登录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">密码</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="performLogin()">登录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改密码模态框 -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密码</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="oldPassword" class="form-label">原密码</label>
                            <input type="password" class="form-control" id="oldPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">新密码</label>
                            <input type="password" class="form-control" id="newPassword" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">确认密码</label>
                            <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="performChangePassword()">修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建/编辑用户模态框 -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">新增用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userName" class="form-label">姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">邮箱 <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3" id="passwordField">
                            <label for="userPassword" class="form-label">密码 <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="userPassword" minlength="6" required>
                        </div>
                        <div class="mb-3">
                            <label for="userPhone" class="form-label">电话</label>
                            <input type="tel" class="form-control" id="userPhone">
                        </div>
                        <div class="mb-3">
                            <label for="userAge" class="form-label">年龄</label>
                            <input type="number" class="form-control" id="userAge" min="0" max="150">
                        </div>
                        <div class="mb-3">
                            <label for="userStatus" class="form-label">状态</label>
                            <select class="form-select" id="userStatus">
                                <option value="1">活跃</option>
                                <option value="0">未激活</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 提示消息 -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let userModal;
        let loginModal;
        let changePasswordModal;
        let isEditMode = false;

        document.addEventListener('DOMContentLoaded', function() {
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            checkLoginStatus();
        });

        function showCreateModal() {
            isEditMode = false;
            document.getElementById('userModalTitle').textContent = '新增用户';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('passwordField').style.display = 'block';
            document.getElementById('userPassword').required = true;
            userModal.show();
        }

        function showEditModal(id) {
            isEditMode = true;
            document.getElementById('userModalTitle').textContent = '编辑用户';
            document.getElementById('passwordField').style.display = 'none';
            document.getElementById('userPassword').required = false;

            fetch(`/api/users/${id}`, { headers: getAuthHeader() })
                .then(response => response.json())
                .then(user => {
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userName').value = user.name;
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userPhone').value = user.phone || '';
                    document.getElementById('userAge').value = user.age || '';
                    document.getElementById('userStatus').value = user.status;
                    userModal.show();
                })
                .catch(error => showToast('获取用户信息失败', 'danger'));
        }

        function saveUser() {
            const form = document.getElementById('userForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const userId = document.getElementById('userId').value;
            const data = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                phone: document.getElementById('userPhone').value,
                age: parseInt(document.getElementById('userAge').value) || 0,
                status: parseInt(document.getElementById('userStatus').value)
            };

            // 新增用户时需要密码
            if (!userId) {
                const password = document.getElementById('userPassword').value;
                if (!password) {
                    showToast('请输入密码', 'danger');
                    return;
                }
                data.password = password;
            }

            const url = userId ? `/api/users/${userId}` : '/api/users';
            const method = userId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    ...getAuthHeader(),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showToast(result.error, 'danger');
                } else {
                    showToast(userId ? '更新成功' : '创建成功', 'success');
                    userModal.hide();
                    setTimeout(() => location.reload(), 500);
                }
            })
            .catch(error => showToast('操作失败', 'danger'));
        }

        function deleteUser(id) {
            if (!confirm('确定要删除该用户吗？')) {
                return;
            }

            fetch(`/api/users/${id}`, {
                method: 'DELETE',
                headers: getAuthHeader()
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showToast(result.error, 'danger');
                } else {
                    showToast('删除成功', 'success');
                    setTimeout(() => location.reload(), 500);
                }
            })
            .catch(error => showToast('删除失败', 'danger'));
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // 认证相关函数
        function getAuthHeader() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');

            if (token) {
                document.getElementById('navAuthButtons').style.display = 'none';
                document.getElementById('navUserInfo').style.display = 'block';
                document.getElementById('welcomeText').textContent = `欢迎, ${user.name || user.email}`;
                document.getElementById('loginRequired').style.display = 'none';
                document.getElementById('userContent').style.display = 'block';
            } else {
                document.getElementById('navAuthButtons').style.display = 'block';
                document.getElementById('navUserInfo').style.display = 'none';
                document.getElementById('loginRequired').style.display = 'block';
                document.getElementById('userContent').style.display = 'none';
            }
        }

        function showLoginModal() {
            document.getElementById('loginForm').reset();
            loginModal.show();
        }

        function performLogin() {
            const form = document.getElementById('loginForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    showToast('登录成功', 'success');
                    loginModal.hide();
                    checkLoginStatus();
                } else {
                    showToast(data.error || '登录失败', 'danger');
                }
            })
            .catch(error => showToast('登录失败: ' + error.message, 'danger'));
        }

        function logout() {
            fetch('/api/auth/logout', {
                method: 'POST',
                headers: getAuthHeader()
            })
            .then(() => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                showToast('退出成功', 'success');
                checkLoginStatus();
            })
            .catch(error => {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                showToast('退出成功', 'success');
                checkLoginStatus();
            });
        }

        function showChangePasswordModal() {
            document.getElementById('changePasswordForm').reset();
            changePasswordModal.show();
        }

        function performChangePassword() {
            const form = document.getElementById('changePasswordForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showToast('两次输入的密码不一致', 'danger');
                return;
            }

            fetch('/api/auth/change-password', {
                method: 'POST',
                headers: {
                    ...getAuthHeader(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    showToast('密码修改成功', 'success');
                    changePasswordModal.hide();
                } else {
                    showToast(data.error || '密码修改失败', 'danger');
                }
            })
            .catch(error => showToast('密码修改失败: ' + error.message, 'danger'));
        }
    </script>
</body>
</html>
